version: 1.0.{build}
skip_tags: true
image: Visual Studio 2017
install:
- cmd: git submodule -q update --init
build_script:
- cmd: |-
    rem BMP2Tile
    rem Can't easily do Delphi in appveyor so we just download it
    appveyor DownloadFile https://github.com/maxim-zhao/bmp2tile/releases/download/v0.43/bmp2tile043.zip
    7z x bmp2tile043.zip -obmp2tile -y
    ren bmp2tile\readme.txt readme_bmp2tile.txt
    7z a tools.7z .\bmp2tile\bmp2tile.exe .\bmp2tile\readme_bmp2tile.txt

    rem compressor DLLs
    msbuild bmp2tilecompressors\compressors\tilecompressordlls.sln /m /p:Platform=x86;Configuration=Release
    7z a tools.7z .\bmp2tilecompressors\compressors\Release\*.dll

    rem WLA DX
    cd wla-dx
    cmake .
    cmake --build . --config Release --target wlalink
    cmake --build . --config Release --target wla-z80
    cd ..
    ren wla-dx\LICENSE wladx_license.txt
    ren wla-dx\readme.md wladx_readme.md
    7z a tools.7z .\wla-dx\binaries\Release\wlalink.exe .\wla-dx\binaries\Release\wla-z80.exe .\wla-dx\wladx_license.txt .\wla-dx\wladx_readme.md

    rem PSGTool
    ren PSGTool\License.txt license_PSGTool.txt
    ren PSGTool\readme.txt readme_PSGTool.txt
    7z a tools.7z .\PSGTool\PSGTool.jar .\PSGTool\license_PSGTool.txt .\PSGTool\readme_PSGTool.txt psgtool.cmd
    
    rem Compile.bat
    7z a tools.7z Compile.bat

    rem setup.cmd
    7z a tools.7z setup.cmd
artifacts:
- path: '*.7z'
  name: Package
deploy:
- provider: GitHub
  auth_token:
    secure: KbY6wD6RTuotJxi7BdGQWg4e6rEc9OMP1u0keEYIrO9CrV9C8OJNSTjaOAmNH1LJ
  artifact: Package